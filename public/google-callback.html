<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Authentication</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
        }
        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        h1 {
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
        }
        p {
            margin: 0;
            opacity: 0.9;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>Processing Authentication...</h1>
        <p id="status">Please wait while we complete your sign-in</p>
    </div>

    <script>
        (function() {
            const statusEl = document.getElementById('status');

            function sendAuthDataToParent(authData) {
                localStorage.setItem('googleAuthResponse', JSON.stringify(authData));

                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'googleAuthResponse',
                            data: authData
                        }, window.location.origin);
                    }
                } catch (e) {
                    // postMessage may be blocked by COOP policy
                }
            }

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const success = urlParams.get('success');
                const token = urlParams.get('token');
                const userId = urlParams.get('userId');
                const email = urlParams.get('email');
                const username = urlParams.get('username');
                const expiresIn = urlParams.get('expiresIn');
                const errorParam = urlParams.get('error');

                if (errorParam || success === 'false') {
                    const errorData = {
                        success: false,
                        message: errorParam ? decodeURIComponent(errorParam) : 'Authentication failed'
                    };

                    sendAuthDataToParent(errorData);
                    statusEl.textContent = 'Authentication failed: ' + errorData.message;
                    statusEl.className = 'error';

                    setTimeout(() => {
                        try {
                            window.close();
                        } catch (e) {
                            statusEl.textContent += ' - Please close this window.';
                        }
                    }, 2000);
                    return;
                }

                if (token && userId && email && username) {
                    const authData = {
                        success: true,
                        token: decodeURIComponent(token),
                        expiresIn: expiresIn ? parseInt(expiresIn) : 3600,
                        user: {
                            id: parseInt(userId),
                            email: decodeURIComponent(email),
                            username: decodeURIComponent(username)
                        }
                    };

                    sendAuthDataToParent(authData);
                    statusEl.textContent = 'Authentication successful!';
                    statusEl.className = 'success';

                    setTimeout(() => {
                        try {
                            window.close();
                        } catch (e) {
                            statusEl.textContent = 'Success! You can close this window.';
                        }
                    }, 1000);
                    return;
                }

                statusEl.textContent = 'No authentication data received';
                statusEl.className = 'error';

                sendAuthDataToParent({
                    success: false,
                    message: 'No authentication data in callback URL'
                });

                setTimeout(() => {
                    try {
                        window.close();
                    } catch (e) {
                        statusEl.textContent += ' - Please close this window.';
                    }
                }, 2000);

            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.className = 'error';

                sendAuthDataToParent({
                    success: false,
                    message: error.message
                });

                setTimeout(() => {
                    try {
                        window.close();
                    } catch (e) {
                        // Ignore
                    }
                }, 2000);
            }
        })();
    </script>
</body>
</html>
    <div class="container">
        <div class="spinner"></div>
        <h1>Authenticating with Google</h1>
        <p id="message">Please wait...</p>
        <div id="error-container"></div>
    </div>

    <script>
        (function() {
            const messageEl = document.getElementById('message');
            const errorContainer = document.getElementById('error-container');

            function showError(message) {
                errorContainer.innerHTML = `<div class="error">${message}</div>`;
                messageEl.textContent = 'Authentication failed';
            }

            function parseResponseFromBody() {
                try {
                    // Check if the response is JSON in the body
                    const bodyText = document.body.innerText || document.body.textContent;

                    // Try to find JSON in the page
                    const jsonMatch = bodyText.match(/\{[^}]*"token"[^}]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }

                    // Try to parse entire body as JSON
                    const parsed = JSON.parse(bodyText);
                    if (parsed.token) {
                        return parsed;
                    }
                } catch (e) {
                    console.error('Failed to parse response:', e);
                }
                return null;
            }

            function processAuthResponse() {
                try {
                    // Method 1: Check if backend rendered JSON in page
                    const response = parseResponseFromBody();

                    if (response && response.token) {
                        messageEl.textContent = 'Authentication successful! Closing window...';

                        // Store in localStorage for parent window to read
                        if (window.opener) {
                            // Send to parent via localStorage (cross-window communication)
                            localStorage.setItem('googleAuthResponse', JSON.stringify(response));

                            // Also try postMessage as backup
                            try {
                                window.opener.postMessage({
                                    type: 'GOOGLE_AUTH_SUCCESS',
                                    data: response
                                }, window.location.origin);
                            } catch (e) {
                                console.error('PostMessage failed:', e);
                            }
                        }

                        // Close popup after short delay
                        setTimeout(() => {
                            window.close();
                        }, 1000);
                        return;
                    }

                    // Method 2: Check URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');
                    const email = urlParams.get('email');

                    if (token && email) {
                        const urlResponse = {
                            success: true,
                            token: token,
                            expiresIn: parseInt(urlParams.get('expiresIn') || '36000000'),
                            user: {
                                id: parseInt(urlParams.get('userId') || '0'),
                                email: email,
                                username: urlParams.get('username') || email
                            }
                        };

                        localStorage.setItem('googleAuthResponse', JSON.stringify(urlResponse));

                        if (window.opener) {
                            try {
                                window.opener.postMessage({
                                    type: 'GOOGLE_AUTH_SUCCESS',
                                    data: urlResponse
                                }, window.location.origin);
                            } catch (e) {
                                console.error('PostMessage failed:', e);
                            }
                        }

                        messageEl.textContent = 'Authentication successful! Closing window...';
                        setTimeout(() => window.close(), 1000);
                        return;
                    }

                    // If we're still on OAuth flow, just wait
                    if (window.location.href.includes('accounts.google.com')) {
                        messageEl.textContent = 'Redirecting to Google...';
                        return;
                    }

                    // After delay, try parsing again (for slow loading pages)
                    setTimeout(() => {
                        const retryResponse = parseResponseFromBody();
                        if (retryResponse && retryResponse.token) {
                            processAuthResponse();
                        }
                    }, 1000);

                } catch (error) {
                    console.error('Error processing auth response:', error);
                    showError('Failed to process authentication response');
                }
            }

            // Run immediately
            processAuthResponse();

            // Also run after page fully loads
            window.addEventListener('load', processAuthResponse);

            // Listen for messages from backend
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'GOOGLE_AUTH_RESPONSE') {
                    localStorage.setItem('googleAuthResponse', JSON.stringify(event.data.data));
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'GOOGLE_AUTH_SUCCESS',
                            data: event.data.data
                        }, window.location.origin);
                    }
                    window.close();
                }
            });

        })();
    </script>
</body>
</html>
